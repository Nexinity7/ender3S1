[include shell_command.cfg]
# This file contains pin mappings for the stock 2021 Creality Ender 3
# S1 & S1 Pro. To use this config, check the STM32 Chip on the
# Mainboard, during "make menuconfig" select accordingly either the
# STM32F103 with "28KiB bootloader" or the STM32F401 with
# "64KiB bootloader" and serial (on USART1 PA10/PA9) for both.

# For a direct serial connection, in "make menuconfig" select
# "Enable extra low-level configuration options" and  Serial
# (on USART2 PA3/PA2), which is on the 10 pin IDC cable used
# for the LCD module as follows: 3: Tx, 4: Rx, 9: GND, 10: VCC

# Flash this firmware by copying "out/klipper.bin" to a SD card and
# turning on the printer with the card inserted. The filename
# must be changed to "firmware.bin"

# With STM32F401, you might need to put "firmware.bin" in a
# folder on the SD card called "STM32F4_UPDATE" in order to flash.

# See docs/Config_Reference.md for a description of parameters.

[include mainsail.cfg]
[exclude_object]
#[include timelapse.cfg]

# Uncomment for resonance testing w/ ADXL345
#include btt-adxl345.cfg]

##Begin KAMP section

# This file contains all settings for KAMP, and must be included in printer.cfg with:
[include KAMP_Settings.cfg]

### The following [includes] can be uncommented from within KAMP_Settings.cfg. ###

# This file enables the use of adaptive meshing.
#[include Adaptive_Meshing.cfg]

# This file enables the use of adaptive line purging.
#[include ./KAMP/Line_Purge.cfg]

# This file enables the use of the adaptive Voron logo purge.
[include ./KAMP/Voron_Purge.cfg]

# This file enables the use of KAMP's Smart Park feature.
#[include ./KAMP/Smart_Park.cfg]

##End KAMP

[include K-ShakeTune/*.cfg]

#[include part-cooling.cfg]

[firmware_retraction]
retract_length: 0.8
#   The length of filament (in mm) to retract when G10 is activated,
#   and to unretract when G11 is activated (but see
#   unretract_extra_length below). The default is 0 mm.
retract_speed: 60
#   The speed of retraction, in mm/s. The default is 20 mm/s.
unretract_extra_length: 0
#   The length (in mm) of *additional* filament to add when
#   unretracting.
unretract_speed: 40
#   The speed of unretraction, in mm/s. The default is 10 mm/s.

[gcode_macro START_PRINT]
description: Concurrent heat → mesh → pre-touch wipe (≤150C) → CARTO touch → heat to HOT → post-wipe → purge
gcode:
  {% set BED   = params.BED_TEMP|default(60)|int %}
  {% set HOT   = params.EXTRUDER_TEMP|default(205)|int %}
  {% set TOUCH = 150 if HOT > 150 else HOT %}

  G90
  M83
  G92 E0

  ; start both heaters
  M140 S{BED}                 ; bed heat (no wait)
  M104 S{TOUCH}               ; nozzle toward ≤150C (no wait)

  G28                         ; home while heating
  M190 S{BED}                 ; wait for bed at temp
  M109 S{TOUCH}               ; ensure nozzle is at touch temp (≤150C)

  ; --- WIPE AND LEVEL ---
  G28 Z
  CLEAN_NOZZLE
  BED_MESH_CLEAR
  BED_MESH_CALIBRATE          ; standard Klipper mesh (no adaptive plugin)

  ; --- PRE-TOUCH WIPE @ ~150C ---
  CLEAN_NOZZLE
  CARTOGRAPHER_TOUCH          ; precision touch (requires ≤150C)

  ; --- HEAT TO FINAL TEMP, THEN POST-WIPE ---
  M109 S{HOT}                 ; go to final print temp and wait
  CLEAN_NOZZLE                ; post-heat wipe at print temp

  ; purge and start
  VORON_PURGE
  G92 E0


[gcode_macro END_PRINT]
description: Move head up, push bed out, and shutdown all steppers and heaters
gcode:
  G91 ;Relative positioning
  G1 E-2 F2700 ;Retract a bit
  G1 E-2 Z0.2 F2400 ;Retract and raise Z
  G1 X5 Y5 F3000 ;Wipe out
  G1 Z10 ;Raise Z more
  G90 ;Absolute positioning

  G1 X20 Y200 ;Present print
  M106 S0 ;Turn-off fan
  M104 S0 ;Turn-off hotend
  M140 S0 ;Turn-off bed

  M84 X Y E ;Disable all steppers but Z

[gcode_arcs]
resolution: 0.1
#   An arc will be split into segments. Each segment's length will
#   equal the resolution in mm set above. Lower values will produce a
#   finer arc, but also more work for your machine. Arcs smaller than
#   the configured value will become straight lines. The default is
#   1mm.

[stepper_x]
step_pin: PC2
dir_pin: PB9
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: !PA5
position_endstop: -4
position_max: 250
position_min: -6
homing_speed: 100

[stepper_y]
step_pin: PB8
dir_pin: PB7
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: !PA6
position_endstop: -8
position_max: 235.5
position_min: -10
homing_speed: 100

[stepper_z]
step_pin: PB6
dir_pin: !PB5
enable_pin: !PC3
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_max: 260
position_min: -4
homing_retract_dist: 0

[tmc2208 stepper_x]
uart_pin: PB1
sense_resistor: 0.150
run_current: 0.7
hold_current: 0.5
interpolate: True
stealthchop_threshold: 0

[tmc2208 stepper_y]
uart_pin: PA13
sense_resistor: 0.150
run_current: 0.7
hold_current: 0.5
interpolate: True
stealthchop_threshold: 0

[tmc2208 stepper_z]
uart_pin: PA14
sense_resistor: 0.150
run_current: 0.7
interpolate: True
stealthchop_threshold: 0

[tmc2208 extruder]
uart_pin: PA3
sense_resistor: 0.150
run_current: 0.8
interpolate: True
stealthchop_threshold: 0

[extruder]
step_pin: PB4
dir_pin: PB3
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12
#Rotation distance calibrated 05/24/24
#rotation_distance: 26.359 (original)
#rotation_distance: 26.443 (dads)
#rotation_distance: 26.648
#rotation_distance: 26.968
#rotation_distance: 26.563
#rotation_distance: 26.653
rotation_distance: 26.626
#rotation_distance: 26.613

nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
pressure_advance: 0.02
min_temp: 0
max_temp: 300
max_extrude_cross_section: 5 # Added for KAMP
max_extrude_only_distance: 101

[heater_bed]
heater_pin: PA7
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 105

[heater_fan hotend_fan]
pin: PC0

[fan]
pin: PA0

#[bltouch]
#sensor_pin: ^PC14
#control_pin: PC13
#x_offset: -45.0
#y_offset: 0.0
#probe_with_touch_mode: true
#stow_on_each_sample: false
#z_offset = 3.225

[mcu]
serial: /dev/ttyUSB0
serial: /dev/serial/by-path/platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.2:1.0-port0
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 5000
max_z_velocity: 10
max_z_accel: 100

[mcu scanner] 
serial: /dev/serial/by-id/usb-Cartographer_614e_38002100124330394D363620-if00

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: -39.2                        
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.062
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[bed_mesh]
speed: 250
horizontal_move_z: 5.2
mesh_min: 20,20
mesh_max: 215,190
probe_count: 20,20
algorithm: bicubic
bicubic_tension: 0.2
mesh_pps: 4, 4
fade_start: 1
fade_end: 10
fade_target: 0
zero_reference_position: 125.00,115.00
#move_check_distance: 5
#split_delta_z: .025

[safe_z_home]
home_xy_position: 117.5, 151.5
speed: 200
z_hop: 10
z_hop_speed: 10

[filament_switch_sensor e0_sensor]
switch_pin: !PC15
pause_on_runout: true
runout_gcode: PAUSE

[pause_resume]
recover_velocity: 25

[screws_tilt_adjust]
screw1: 26, 220
screw2: 201, 220
screw3: 201, 70
screw4: 26, 70
screw1_name: Back Left
screw2_name: Back Right
screw3_name: Front Right
screw4_name: Front Left
speed: 250
horizontal_move_z: 5.2
screw_thread: CW-M4

[gcode_macro screw_tilt]
gcode:
  G28
  SCREWS_TILT_CALCULATE
  
[bed_screws]
#screw1: 66, 192
#screw2: 240, 192
#screw3: 240, 22
#screw4: 66, 22
screw1: 26, 26
screw2: 201, 26
screw3: 201, 195
screw4: 26, 195

[input_shaper]
shaper_type_x = mzv
shaper_freq_x = 61.2
# ei at 79.8 Hz <=11700 accel 6/6/24
# mzv at 61.2 Hz <=11000 accel 7/29/25
shaper_type_y = mzv
shaper_freq_y = 37.0
# ei at 54.2Hz <=5400 accel 6/6/24
# mzv at 37.0 Hz <=4000 accel 7/29/25

[include macros.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 19.605
#*# pid_ki = 0.927
#*# pid_kd = 103.662
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 74.493
#*# pid_ki = 2.087
#*# pid_kd = 664.849
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.019607, 0.003775, -0.021924, -0.025955, -0.006476, 0.022286, 0.001265, 0.020614, 0.015354, 0.027225, 0.020459, 0.026093, 0.018550, 0.053676, 0.040208, 0.034269, 0.038062, 0.029550, 0.016072, 0.006984
#*# 	-0.018018, -0.028093, -0.040973, -0.031031, -0.031672, -0.022550, -0.017635, -0.011137, -0.025060, -0.011996, -0.003256, -0.017702, -0.031788, -0.020154, -0.019204, -0.027043, -0.036924, -0.032938, -0.021791, -0.054377
#*# 	-0.032256, -0.038464, -0.065029, -0.056184, -0.042009, -0.038662, -0.043019, -0.027846, -0.031976, -0.034392, -0.036962, -0.032787, -0.053502, -0.023720, -0.029140, -0.032156, -0.040173, -0.047357, -0.043719, -0.069178
#*# 	-0.037141, -0.037842, -0.055472, -0.051275, -0.040195, -0.029649, -0.027282, -0.028655, -0.037011, -0.032064, -0.032034, -0.028302, -0.037225, -0.022460, -0.021573, -0.028777, -0.034634, -0.033600, -0.037145, -0.060090
#*# 	-0.031140, -0.041918, -0.065690, -0.051414, -0.047112, -0.047431, -0.029738, -0.019908, -0.038777, -0.033408, -0.020274, -0.029537, -0.041277, -0.020378, -0.018185, -0.030652, -0.030996, -0.024681, -0.021994, -0.050184
#*# 	-0.037298, -0.039508, -0.058406, -0.053098, -0.039153, -0.031269, -0.027537, -0.022653, -0.033563, -0.027845, -0.018668, -0.020078, -0.038927, -0.014830, -0.017348, -0.021789, -0.022032, -0.017772, -0.024324, -0.054000
#*# 	-0.040136, -0.042452, -0.054730, -0.055357, -0.047035, -0.036074, -0.025290, -0.013243, -0.029307, -0.025780, -0.014169, -0.012853, -0.033721, -0.007142, -0.008426, -0.012630, -0.019952, -0.019546, -0.012335, -0.042340
#*# 	-0.048148, -0.046170, -0.056873, -0.053056, -0.040974, -0.030590, -0.031948, -0.016593, -0.022358, -0.020848, -0.008972, -0.009707, -0.028673, -0.003375, -0.002896, -0.011695, -0.017390, -0.015148, -0.012267, -0.041826
#*# 	-0.044920, -0.044918, -0.053834, -0.058095, -0.043732, -0.022034, -0.021561, -0.006819, -0.020191, -0.021585, -0.009466, -0.006732, -0.024648, -0.001002, -0.002250, -0.008364, -0.010729, -0.009570, -0.010268, -0.031089
#*# 	-0.047926, -0.043309, -0.053224, -0.049589, -0.040088, -0.023405, -0.024116, -0.012033, -0.017415, -0.014284, -0.007840, -0.006184, -0.023489, 0.001650, -0.001447, -0.005613, -0.008952, -0.002406, -0.005006, -0.031777
#*# 	-0.039945, -0.036478, -0.051542, -0.048068, -0.043512, -0.023624, -0.029120, -0.004385, -0.015563, -0.013765, -0.004178, 0.000836, -0.021386, 0.007735, 0.004642, -0.000854, -0.004625, -0.003137, -0.006434, -0.031242
#*# 	-0.034046, -0.029576, -0.048190, -0.047978, -0.037866, -0.022686, -0.010388, -0.006962, -0.015337, -0.008324, -0.001026, -0.001529, -0.017493, 0.012404, 0.006046, 0.000880, -0.006066, -0.004495, -0.014218, -0.044343
#*# 	-0.023150, -0.022366, -0.044001, -0.039474, -0.035453, -0.020004, -0.007801, -0.004061, -0.012639, -0.009997, 0.000869, -0.007212, -0.026706, -0.000125, 0.003650, -0.004363, -0.012732, -0.004278, -0.012654, -0.043036
#*# 	-0.022935, -0.017363, -0.034594, -0.033190, -0.031608, -0.014305, -0.003591, 0.002307, -0.007615, -0.004880, 0.002343, -0.000861, -0.021459, 0.004305, 0.008711, -0.000390, -0.007499, -0.001599, -0.011140, -0.041346
#*# 	-0.029128, -0.019370, -0.034615, -0.032218, -0.031268, -0.005452, 0.003622, 0.006677, -0.005507, -0.002182, 0.005211, 0.005269, -0.019259, 0.007202, 0.003193, -0.006228, -0.009680, -0.004235, -0.014250, -0.045965
#*# 	-0.018035, -0.014937, -0.026251, -0.026509, -0.023301, -0.000574, -0.004053, 0.014878, 0.001562, 0.004645, 0.008638, 0.002924, -0.016851, 0.011414, 0.006183, -0.004194, -0.011618, -0.006529, -0.018345, -0.045033
#*# 	-0.005615, -0.007726, -0.020327, -0.020052, -0.016633, 0.005625, 0.011325, 0.020885, 0.012662, 0.010471, 0.014959, 0.008231, -0.011931, 0.017665, 0.014246, -0.000558, -0.010040, -0.001486, -0.014143, -0.046639
#*# 	-0.001240, 0.001106, -0.013758, -0.015401, -0.005679, 0.012866, 0.015964, 0.028799, 0.021971, 0.019812, 0.022622, 0.014662, -0.005380, 0.028313, 0.018825, 0.001896, -0.007588, -0.002862, -0.016059, -0.047167
#*# 	0.011818, 0.014909, -0.001240, -0.000138, 0.005090, 0.020593, 0.027396, 0.037365, 0.032283, 0.026021, 0.030265, 0.020871, -0.003847, 0.027476, 0.020197, 0.002628, -0.011346, -0.008740, -0.021330, -0.050209
#*# 	0.022599, 0.015069, 0.000030, 0.003250, 0.012016, 0.025579, 0.028046, 0.038332, 0.035882, 0.031698, 0.034743, 0.027123, 0.004688, 0.035447, 0.029436, 0.007601, -0.000837, 0.000902, -0.015258, -0.040624
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 215.0
#*# min_y = 20.0
#*# max_y = 190.0
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 2750
#*# scanner_touch_speed = 3
#*# scanner_touch_z_offset = 0.140
#*#
#*# [scanner model default]
#*# model_coef = 2.0451077483356555,
#*# 	1.6607884787592444,
#*# 	-0.6019935400970867,
#*# 	1.629276093959081,
#*# 	8.709154577535902,
#*# 	-9.66168769158157,
#*# 	-17.720057116448423,
#*# 	20.3307394447895,
#*# 	10.522175211672552,
#*# 	-11.916968512717027
#*# model_domain = 3.2790314002932685e-07,3.3591588206894234e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 25.245939
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
