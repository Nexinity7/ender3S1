[include shell_command.cfg]
# This file contains pin mappings for the stock 2021 Creality Ender 3
# S1 & S1 Pro. To use this config, check the STM32 Chip on the
# Mainboard, during "make menuconfig" select accordingly either the
# STM32F103 with "28KiB bootloader" or the STM32F401 with
# "64KiB bootloader" and serial (on USART1 PA10/PA9) for both.

# For a direct serial connection, in "make menuconfig" select
# "Enable extra low-level configuration options" and  Serial
# (on USART2 PA3/PA2), which is on the 10 pin IDC cable used
# for the LCD module as follows: 3: Tx, 4: Rx, 9: GND, 10: VCC

# Flash this firmware by copying "out/klipper.bin" to a SD card and
# turning on the printer with the card inserted. The filename
# must be changed to "firmware.bin"

# With STM32F401, you might need to put "firmware.bin" in a
# folder on the SD card called "STM32F4_UPDATE" in order to flash.

# See docs/Config_Reference.md for a description of parameters.

[include mainsail.cfg]
[exclude_object]
#[include timelapse.cfg]

# Uncomment for resonance testing w/ ADXL345
#include btt-adxl345.cfg]

##Begin KAMP section

# This file contains all settings for KAMP, and must be included in printer.cfg with:
[include KAMP_Settings.cfg]

### The following [includes] can be uncommented from within KAMP_Settings.cfg. ###

# This file enables the use of adaptive meshing.
#[include Adaptive_Meshing.cfg]

# This file enables the use of adaptive line purging.
#[include ./KAMP/Line_Purge.cfg]

# This file enables the use of the adaptive Voron logo purge.
[include ./KAMP/Voron_Purge.cfg]

# This file enables the use of KAMP's Smart Park feature.
#[include ./KAMP/Smart_Park.cfg]

##End KAMP

[include K-ShakeTune/*.cfg]

#[include part-cooling.cfg]

[firmware_retraction]
retract_length: 0.8
#   The length of filament (in mm) to retract when G10 is activated,
#   and to unretract when G11 is activated (but see
#   unretract_extra_length below). The default is 0 mm.
retract_speed: 60
#   The speed of retraction, in mm/s. The default is 20 mm/s.
unretract_extra_length: 0
#   The length (in mm) of *additional* filament to add when
#   unretracting.
unretract_speed: 40
#   The speed of unretraction, in mm/s. The default is 10 mm/s.

[gcode_macro START_PRINT]
description: Concurrent heat → mesh → pre-touch wipe (≤150C) → CARTO touch → heat to HOT → post-wipe → purge
gcode:
  {% set BED   = params.BED_TEMP|default(60)|int %}
  {% set HOT   = params.EXTRUDER_TEMP|default(205)|int %}
  {% set TOUCH = 150 if HOT > 150 else HOT %}

  G90
  M83
  G92 E0

  ; start both heaters
  M140 S{BED}                 ; bed heat (no wait)
  M104 S{TOUCH}               ; nozzle toward ≤150C (no wait)
  M106 S255                   ; part fan on to solidify ooze
  G28                         ; home while heating
  M190 S{BED}                 ; wait for bed at temp
  M109 S{TOUCH}               ; ensure nozzle is at touch temp (≤150C)

  ; --- WIPE AND LEVEL ---
  G28 Z
  CLEAN_NOZZLE
  BED_MESH_CLEAR
  BED_MESH_CALIBRATE          ; standard Klipper mesh (no adaptive plugin)

  ; --- PRE-TOUCH WIPE @ ~150C ---
  CLEAN_NOZZLE
  CARTOGRAPHER_TOUCH          ; precision touch (requires ≤150C)

  ; --- HEAT TO FINAL TEMP, THEN POST-WIPE ---
  M109 S{HOT}                 ; go to final print temp and wait
  CLEAN_NOZZLE                ; post-heat wipe at print temp

  ; purge and start
  M106 S0
  VORON_PURGE
  G92 E0


[gcode_macro END_PRINT]
description: Move head up, push bed out, and shutdown all steppers and heaters
gcode:
  G91 ;Relative positioning
  G1 E-2 F2700 ;Retract a bit
  G1 E-2 Z0.2 F2400 ;Retract and raise Z
  G1 X5 Y5 F3000 ;Wipe out
  G1 Z10 ;Raise Z more
  G90 ;Absolute positioning

  G1 X20 Y200 ;Present print
  M106 S0 ;Turn-off fan
  M104 S0 ;Turn-off hotend
  M140 S0 ;Turn-off bed

  M84 X Y E ;Disable all steppers but Z

[gcode_arcs]
resolution: 0.1
#   An arc will be split into segments. Each segment's length will
#   equal the resolution in mm set above. Lower values will produce a
#   finer arc, but also more work for your machine. Arcs smaller than
#   the configured value will become straight lines. The default is
#   1mm.

[stepper_x]
step_pin: PC2
dir_pin: PB9
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: !PA5
position_endstop: -4
position_max: 250
position_min: -6
homing_speed: 100

[stepper_y]
step_pin: PB8
dir_pin: PB7
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: !PA6
position_endstop: -8
position_max: 235.5
position_min: -10
homing_speed: 100

[stepper_z]
step_pin: PB6
dir_pin: !PB5
enable_pin: !PC3
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_max: 260
position_min: -4
homing_retract_dist: 0

[tmc2208 stepper_x]
uart_pin: PB1
sense_resistor: 0.150
run_current: 0.7
hold_current: 0.5
interpolate: True
stealthchop_threshold: 0

[tmc2208 stepper_y]
uart_pin: PA13
sense_resistor: 0.150
run_current: 0.75
hold_current: 0.5
interpolate: True
stealthchop_threshold: 0

[tmc2208 stepper_z]
uart_pin: PA14
sense_resistor: 0.150
run_current: 0.7
interpolate: True
stealthchop_threshold: 0

[tmc2208 extruder]
uart_pin: PA3
sense_resistor: 0.150
run_current: 0.8
interpolate: True
stealthchop_threshold: 0

[extruder]
step_pin: PB4
dir_pin: PB3
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12
#Rotation distance calibrated 05/24/24
#rotation_distance: 26.359 (original)
#rotation_distance: 26.443 (dads)
#rotation_distance: 26.648
#rotation_distance: 26.968
#rotation_distance: 26.563
#rotation_distance: 26.653
rotation_distance: 26.626
#rotation_distance: 26.613

nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
pressure_advance: 0.02
min_temp: 0
max_temp: 300
max_extrude_cross_section: 5 # Added for KAMP
max_extrude_only_distance: 101

[heater_bed]
heater_pin: PA7
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 105

[heater_fan hotend_fan]
pin: PC0

[fan]
pin: PA0

#[bltouch]
#sensor_pin: ^PC14
#control_pin: PC13
#x_offset: -45.0
#y_offset: 0.0
#probe_with_touch_mode: true
#stow_on_each_sample: false
#z_offset = 3.225

[mcu]
serial: /dev/ttyUSB0
serial: /dev/serial/by-path/platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.2:1.0-port0
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 5000
max_z_velocity: 10
max_z_accel: 100

[mcu scanner] 
serial: /dev/serial/by-id/usb-Cartographer_614e_38002100124330394D363620-if00

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: -39.2                        
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.062
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[bed_mesh]
speed: 250
horizontal_move_z: 5.2
mesh_min: 20,20
mesh_max: 215,190
probe_count: 20,20
algorithm: bicubic
bicubic_tension: 0.2
mesh_pps: 4, 4
fade_start: 1
fade_end: 10
fade_target: 0
zero_reference_position: 125.00,115.00
#move_check_distance: 5
#split_delta_z: .025

[safe_z_home]
home_xy_position: 117.5, 151.5
speed: 200
z_hop: 10
z_hop_speed: 10

[filament_switch_sensor e0_sensor]
switch_pin: !PC15
pause_on_runout: true
runout_gcode: PAUSE

[pause_resume]
recover_velocity: 25

[screws_tilt_adjust]
screw1: 26, 220
screw2: 201, 220
screw3: 201, 70
screw4: 26, 70
screw1_name: Back Left
screw2_name: Back Right
screw3_name: Front Right
screw4_name: Front Left
speed: 250
horizontal_move_z: 5.2
screw_thread: CW-M4

[gcode_macro screw_tilt]
gcode:
  G28
  SCREWS_TILT_CALCULATE
  
[bed_screws]
#screw1: 66, 192
#screw2: 240, 192
#screw3: 240, 22
#screw4: 66, 22
screw1: 26, 26
screw2: 201, 26
screw3: 201, 195
screw4: 26, 195

[input_shaper]
shaper_type_x = mzv
shaper_freq_x = 61.2
# ei at 79.8 Hz <=11700 accel 6/6/24
# mzv at 61.2 Hz <=11000 accel 7/29/25
shaper_type_y = mzv
shaper_freq_y = 37.0
# ei at 54.2Hz <=5400 accel 6/6/24
# mzv at 37.0 Hz <=4000 accel 7/29/25

[include macros.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 19.605
#*# pid_ki = 0.927
#*# pid_kd = 103.662
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 74.493
#*# pid_ki = 2.087
#*# pid_kd = 664.849
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.004103, 0.011499, 0.015333, 0.019358, 0.030579, 0.025548, 0.029687, 0.023722, 0.022445, 0.026653, 0.036620, 0.033746, 0.015719, 0.030646, 0.039622, 0.034397, 0.044661, 0.041381, 0.032082, 0.021148
#*# 	  -0.014653, -0.011903, -0.000956, 0.011687, 0.014127, 0.011983, 0.012881, 0.011137, 0.008737, 0.018945, 0.030048, 0.015088, -0.003779, 0.005800, 0.008608, 0.016341, 0.023238, 0.020906, 0.022440, 0.009871
#*# 	  -0.027028, -0.026568, -0.018599, -0.019712, -0.019946, -0.011873, -0.000916, -0.002248, -0.013293, 0.002144, 0.002410, -0.005826, -0.018161, -0.018985, -0.007657, -0.012557, 0.004018, -0.000382, -0.011574, -0.026402
#*# 	  -0.043220, -0.031316, -0.020111, -0.014598, -0.012952, -0.006948, -0.014627, -0.011473, -0.015755, -0.009079, 0.005752, -0.008595, -0.024384, -0.015241, -0.011000, -0.016199, -0.006225, -0.006966, -0.013193, -0.031250
#*# 	  -0.036628, -0.038526, -0.034090, -0.033639, -0.029323, -0.014361, -0.017000, -0.018940, -0.025330, -0.012844, 0.002998, -0.003188, -0.024844, -0.021492, -0.027142, -0.025493, -0.004493, -0.012524, -0.016559, -0.036365
#*# 	  -0.050493, -0.039024, -0.031374, -0.027440, -0.023056, -0.021634, -0.020175, -0.023306, -0.022826, -0.019045, -0.004487, -0.016514, -0.047157, -0.029287, -0.028999, -0.025318, -0.021170, -0.025754, -0.025156, -0.060003
#*# 	  -0.044205, -0.034931, -0.033106, -0.035137, -0.034594, -0.019595, -0.015031, -0.025558, -0.029196, -0.025138, -0.006384, -0.020831, -0.028565, -0.029724, -0.026008, -0.028787, -0.020091, -0.033524, -0.038298, -0.054498
#*# 	  -0.052493, -0.039691, -0.033511, -0.025622, -0.022950, -0.027598, -0.019563, -0.020813, -0.022257, -0.024034, -0.013631, -0.004594, -0.046200, -0.034259, -0.030109, -0.032966, -0.031900, -0.042509, -0.037431, -0.068406
#*# 	  -0.050465, -0.037055, -0.035813, -0.030970, -0.033425, -0.019640, -0.013118, -0.018767, -0.026929, -0.027772, -0.012934, -0.012902, -0.036390, -0.040335, -0.030285, -0.043176, -0.033528, -0.048716, -0.058871, -0.070028
#*# 	  -0.045109, -0.035946, -0.027187, -0.020212, -0.019121, -0.010811, -0.010452, -0.013529, -0.014534, -0.011277, -0.013077, -0.007306, -0.035483, -0.021268, -0.023137, -0.031907, -0.022957, -0.034781, -0.046446, -0.061465
#*# 	  -0.038429, -0.029704, -0.028905, -0.022343, -0.019344, -0.018930, -0.011381, -0.012356, -0.015229, -0.012631, -0.007026, -0.009537, -0.028747, -0.029431, -0.024160, -0.033997, -0.028617, -0.044954, -0.059783, -0.073841
#*# 	  -0.040103, -0.022076, -0.016403, -0.016901, -0.013468, -0.006846, -0.007776, -0.007545, -0.012589, -0.006835, 0.001391, -0.006072, -0.027496, -0.017604, -0.017293, -0.031156, -0.028616, -0.042610, -0.051343, -0.075459
#*# 	  -0.024886, -0.018129, -0.006797, -0.013955, -0.010015, -0.009144, 0.000523, 0.003454, -0.010045, -0.006577, 0.008292, -0.001118, -0.029539, -0.022914, -0.011982, -0.032999, -0.025836, -0.037481, -0.057394, -0.071624
#*# 	  -0.028868, -0.021699, -0.009800, -0.010691, -0.006230, 0.001524, 0.008239, 0.004993, -0.000743, 0.005719, 0.016322, 0.005717, -0.023540, -0.015740, -0.014944, -0.023541, -0.020513, -0.031967, -0.041192, -0.066897
#*# 	  -0.038060, -0.021724, -0.015051, -0.012617, -0.010419, 0.001353, 0.010707, 0.013448, 0.004819, 0.009025, 0.012322, -0.007118, -0.010524, -0.006497, -0.007024, -0.022241, -0.012310, -0.023010, -0.041725, -0.067216
#*# 	  -0.047957, -0.026490, -0.014364, -0.012437, -0.011503, 0.001842, 0.020359, 0.018078, 0.005913, 0.013181, 0.019939, 0.011293, -0.011567, -0.009221, -0.002924, -0.009422, -0.009339, -0.019396, -0.027206, -0.048952
#*# 	  -0.038480, -0.020174, -0.010298, -0.002905, -0.006504, 0.005503, 0.018984, 0.018638, 0.021727, 0.018630, 0.028680, -0.001121, -0.004098, 0.010072, 0.006257, -0.004006, 0.000979, -0.010403, -0.029343, -0.048716
#*# 	  -0.034605, -0.029542, -0.013439, -0.009808, -0.004598, 0.001265, 0.020822, 0.022290, 0.021381, 0.020219, 0.032123, 0.012214, 0.001793, 0.008294, 0.006600, -0.004594, -0.010125, -0.022217, -0.024363, -0.049994
#*# 	  -0.033298, -0.024970, -0.012479, -0.008445, -0.001262, 0.006514, 0.016109, 0.016141, 0.029517, 0.029895, 0.035904, 0.018390, -0.001435, 0.014855, 0.005885, -0.006221, 0.003042, -0.020478, -0.034676, -0.050458
#*# 	  -0.017581, -0.021339, -0.009854, -0.007903, 0.003867, 0.008509, 0.014605, 0.024984, 0.025868, 0.036965, 0.031246, 0.031978, 0.004398, 0.015978, 0.009100, -0.002456, 0.001616, -0.011139, -0.023323, -0.043428
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 215.0
#*# min_y = 20.0
#*# max_y = 190.0
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 4000
#*# scanner_touch_speed = 3
#*# scanner_touch_z_offset = 0.140
#*#
#*# [scanner model default]
#*# model_coef = 2.0451077483356555,
#*# 	1.6607884787592444,
#*# 	-0.6019935400970867,
#*# 	1.629276093959081,
#*# 	8.709154577535902,
#*# 	-9.66168769158157,
#*# 	-17.720057116448423,
#*# 	20.3307394447895,
#*# 	10.522175211672552,
#*# 	-11.916968512717027
#*# model_domain = 3.2790314002932685e-07,3.3591588206894234e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 25.245939
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
