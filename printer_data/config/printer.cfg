[include shell_command.cfg]
# This file contains pin mappings for the stock 2021 Creality Ender 3
# S1 & S1 Pro. To use this config, check the STM32 Chip on the
# Mainboard, during "make menuconfig" select accordingly either the
# STM32F103 with "28KiB bootloader" or the STM32F401 with
# "64KiB bootloader" and serial (on USART1 PA10/PA9) for both.

# For a direct serial connection, in "make menuconfig" select
# "Enable extra low-level configuration options" and  Serial
# (on USART2 PA3/PA2), which is on the 10 pin IDC cable used
# for the LCD module as follows: 3: Tx, 4: Rx, 9: GND, 10: VCC

# Flash this firmware by copying "out/klipper.bin" to a SD card and
# turning on the printer with the card inserted. The filename
# must be changed to "firmware.bin"

# With STM32F401, you might need to put "firmware.bin" in a
# folder on the SD card called "STM32F4_UPDATE" in order to flash.

# See docs/Config_Reference.md for a description of parameters.

[include mainsail.cfg]
[exclude_object]
#[include timelapse.cfg]

# Uncomment for resonance testing w/ ADXL345
#include btt-adxl345.cfg]

##Begin KAMP section

# This file contains all settings for KAMP, and must be included in printer.cfg with:
[include KAMP_Settings.cfg]

### The following [includes] can be uncommented from within KAMP_Settings.cfg. ###

# This file enables the use of adaptive meshing.
#[include Adaptive_Meshing.cfg]

# This file enables the use of adaptive line purging.
#[include ./KAMP/Line_Purge.cfg]

# This file enables the use of the adaptive Voron logo purge.
[include ./KAMP/Voron_Purge.cfg]

# This file enables the use of KAMP's Smart Park feature.
#[include ./KAMP/Smart_Park.cfg]

##End KAMP

[include K-ShakeTune/*.cfg]

#[include part-cooling.cfg]

[firmware_retraction]
retract_length: 0.8
#   The length of filament (in mm) to retract when G10 is activated,
#   and to unretract when G11 is activated (but see
#   unretract_extra_length below). The default is 0 mm.
retract_speed: 60
#   The speed of retraction, in mm/s. The default is 20 mm/s.
unretract_extra_length: 0
#   The length (in mm) of *additional* filament to add when
#   unretracting.
unretract_speed: 40
#   The speed of unretraction, in mm/s. The default is 10 mm/s.

[gcode_macro START_PRINT]
description: Concurrent heat → mesh → pre-touch wipe (≤150C) → CARTO touch → heat to HOT → post-wipe → purge
gcode:
  {% set BED   = params.BED_TEMP|default(60)|int %}
  {% set HOT   = params.EXTRUDER_TEMP|default(205)|int %}
  {% set TOUCH = 150 if HOT > 150 else HOT %}

  G90
  M83
  G92 E0

  ; start both heaters
  M140 S{BED}                 ; bed heat (no wait)
  M104 S{TOUCH}               ; nozzle toward ≤150C (no wait)

  G28                         ; home while heating
  M190 S{BED}                 ; wait for bed at temp
  M109 S{TOUCH}               ; ensure nozzle is at touch temp (≤150C)

  ; --- WIPE AND LEVEL ---
  G28 Z
  CLEAN_NOZZLE
  BED_MESH_CLEAR
  BED_MESH_CALIBRATE          ; standard Klipper mesh (no adaptive plugin)

  ; --- PRE-TOUCH WIPE @ ~150C ---
  CLEAN_NOZZLE
  CARTOGRAPHER_TOUCH          ; precision touch (requires ≤150C)

  ; --- HEAT TO FINAL TEMP, THEN POST-WIPE ---
  M109 S{HOT}                 ; go to final print temp and wait
  CLEAN_NOZZLE                ; post-heat wipe at print temp

  ; purge and start
  VORON_PURGE
  G92 E0


[gcode_macro END_PRINT]
description: Move head up, push bed out, and shutdown all steppers and heaters
gcode:
  G91 ;Relative positioning
  G1 E-2 F2700 ;Retract a bit
  G1 E-2 Z0.2 F2400 ;Retract and raise Z
  G1 X5 Y5 F3000 ;Wipe out
  G1 Z10 ;Raise Z more
  G90 ;Absolute positioning

  G1 X20 Y200 ;Present print
  M106 S0 ;Turn-off fan
  M104 S0 ;Turn-off hotend
  M140 S0 ;Turn-off bed

  M84 X Y E ;Disable all steppers but Z

[gcode_arcs]
resolution: 0.1
#   An arc will be split into segments. Each segment's length will
#   equal the resolution in mm set above. Lower values will produce a
#   finer arc, but also more work for your machine. Arcs smaller than
#   the configured value will become straight lines. The default is
#   1mm.

[stepper_x]
step_pin: PC2
dir_pin: PB9
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: !PA5
position_endstop: -4
position_max: 250
position_min: -6
homing_speed: 100

[stepper_y]
step_pin: PB8
dir_pin: PB7
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: !PA6
position_endstop: -8
position_max: 235.5
position_min: -10
homing_speed: 100

[stepper_z]
step_pin: PB6
dir_pin: !PB5
enable_pin: !PC3
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_max: 260
position_min: -4
homing_retract_dist: 0

[tmc2208 stepper_x]
uart_pin: PB1
sense_resistor: 0.150
run_current: 0.7
hold_current: 0.5
interpolate: True
stealthchop_threshold: 0

[tmc2208 stepper_y]
uart_pin: PA13
sense_resistor: 0.150
run_current: 0.75
hold_current: 0.5
interpolate: True
stealthchop_threshold: 0

[tmc2208 stepper_z]
uart_pin: PA14
sense_resistor: 0.150
run_current: 0.7
interpolate: True
stealthchop_threshold: 0

[tmc2208 extruder]
uart_pin: PA3
sense_resistor: 0.150
run_current: 0.8
interpolate: True
stealthchop_threshold: 0

[extruder]
step_pin: PB4
dir_pin: PB3
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12
#Rotation distance calibrated 05/24/24
#rotation_distance: 26.359 (original)
#rotation_distance: 26.443 (dads)
#rotation_distance: 26.648
#rotation_distance: 26.968
#rotation_distance: 26.563
#rotation_distance: 26.653
rotation_distance: 26.626
#rotation_distance: 26.613

nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
pressure_advance: 0.02
min_temp: 0
max_temp: 300
max_extrude_cross_section: 5 # Added for KAMP
max_extrude_only_distance: 101

[heater_bed]
heater_pin: PA7
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 105

[heater_fan hotend_fan]
pin: PC0

[fan]
pin: PA0

#[bltouch]
#sensor_pin: ^PC14
#control_pin: PC13
#x_offset: -45.0
#y_offset: 0.0
#probe_with_touch_mode: true
#stow_on_each_sample: false
#z_offset = 3.225

[mcu]
serial: /dev/ttyUSB0
serial: /dev/serial/by-path/platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.2:1.0-port0
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 5000
max_z_velocity: 10
max_z_accel: 100

[mcu scanner] 
serial: /dev/serial/by-id/usb-Cartographer_614e_38002100124330394D363620-if00

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: -39.2                        
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.062
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[bed_mesh]
speed: 250
horizontal_move_z: 5.2
mesh_min: 20,20
mesh_max: 215,190
probe_count: 20,20
algorithm: bicubic
bicubic_tension: 0.2
mesh_pps: 4, 4
fade_start: 1
fade_end: 10
fade_target: 0
zero_reference_position: 125.00,115.00
#move_check_distance: 5
#split_delta_z: .025

[safe_z_home]
home_xy_position: 117.5, 151.5
speed: 200
z_hop: 10
z_hop_speed: 10

[filament_switch_sensor e0_sensor]
switch_pin: !PC15
pause_on_runout: true
runout_gcode: PAUSE

[pause_resume]
recover_velocity: 25

[screws_tilt_adjust]
screw1: 26, 220
screw2: 201, 220
screw3: 201, 70
screw4: 26, 70
screw1_name: Back Left
screw2_name: Back Right
screw3_name: Front Right
screw4_name: Front Left
speed: 250
horizontal_move_z: 5.2
screw_thread: CW-M4

[gcode_macro screw_tilt]
gcode:
  G28
  SCREWS_TILT_CALCULATE
  
[bed_screws]
#screw1: 66, 192
#screw2: 240, 192
#screw3: 240, 22
#screw4: 66, 22
screw1: 26, 26
screw2: 201, 26
screw3: 201, 195
screw4: 26, 195

[input_shaper]
shaper_type_x = mzv
shaper_freq_x = 61.2
# ei at 79.8 Hz <=11700 accel 6/6/24
# mzv at 61.2 Hz <=11000 accel 7/29/25
shaper_type_y = mzv
shaper_freq_y = 37.0
# ei at 54.2Hz <=5400 accel 6/6/24
# mzv at 37.0 Hz <=4000 accel 7/29/25

[include macros.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 19.605
#*# pid_ki = 0.927
#*# pid_kd = 103.662
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 74.493
#*# pid_ki = 2.087
#*# pid_kd = 664.849
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.000564, 0.008193, 0.017037, 0.019583, 0.002479, 0.015937, 0.033702, 0.012874, 0.019947, 0.029994, 0.035671, 0.028963, 0.015875, 0.021097, 0.014289, 0.017709, 0.023432, 0.014583, -0.004027, -0.019879
#*# 	  -0.050629, -0.028624, -0.009030, -0.006329, -0.008228, -0.011214, -0.002726, -0.010456, -0.005354, 0.008858, 0.016947, 0.004234, -0.007548, -0.007518, -0.009873, -0.008116, -0.003271, -0.008951, -0.027895, -0.043469
#*# 	  -0.043781, -0.033657, -0.026132, -0.020931, -0.027273, -0.018249, -0.002514, -0.025067, -0.024787, -0.008098, -0.006775, -0.008578, -0.025164, -0.019533, -0.037274, -0.018958, -0.008625, -0.016046, -0.035330, -0.060092
#*# 	  -0.042110, -0.032363, -0.031747, -0.025519, -0.023393, -0.023582, -0.017083, -0.016014, -0.019089, -0.010116, 0.005689, -0.004751, -0.014395, -0.007205, -0.020782, -0.021751, -0.011412, -0.027457, -0.040030, -0.062531
#*# 	  -0.044718, -0.038233, -0.038610, -0.029844, -0.035000, -0.027086, -0.007346, -0.026154, -0.025868, -0.019215, -0.009272, -0.010239, -0.028161, -0.023834, -0.039743, -0.029136, -0.015078, -0.030376, -0.039541, -0.066847
#*# 	  -0.052068, -0.042752, -0.041310, -0.030662, -0.034396, -0.029581, -0.025871, -0.023511, -0.026648, -0.018530, -0.004400, -0.012899, -0.035496, -0.026790, -0.039509, -0.032651, -0.022059, -0.032254, -0.045917, -0.076179
#*# 	  -0.051092, -0.041164, -0.034796, -0.028953, -0.034402, -0.025117, -0.008917, -0.029226, -0.032243, -0.022785, -0.016051, -0.017626, -0.040511, -0.035213, -0.050157, -0.033727, -0.027573, -0.046452, -0.053405, -0.079053
#*# 	  -0.055210, -0.040460, -0.033766, -0.027999, -0.034584, -0.025658, -0.019705, -0.024410, -0.020815, -0.017113, -0.013492, -0.007072, -0.031971, -0.027142, -0.042035, -0.036269, -0.031516, -0.046855, -0.055413, -0.087163
#*# 	  -0.050551, -0.039043, -0.033097, -0.018450, -0.027412, -0.017143, -0.006671, -0.022563, -0.020265, -0.012734, -0.006397, -0.008011, -0.034213, -0.030383, -0.035842, -0.035834, -0.030385, -0.043159, -0.049095, -0.083059
#*# 	  -0.053780, -0.036667, -0.029831, -0.022927, -0.029535, -0.017819, -0.014379, -0.020849, -0.010755, -0.016858, 0.001902, -0.005261, -0.028859, -0.022699, -0.037193, -0.030393, -0.024818, -0.039307, -0.052490, -0.082551
#*# 	  -0.038846, -0.027905, -0.021531, -0.013605, -0.018853, -0.013883, -0.000707, -0.016017, -0.010761, -0.007185, -0.000315, 0.000777, -0.024187, -0.018799, -0.034742, -0.030957, -0.025619, -0.040847, -0.054101, -0.086575
#*# 	  -0.033907, -0.023433, -0.016439, -0.016032, -0.020318, -0.011427, -0.003548, -0.011488, -0.001284, 0.008461, 0.004128, -0.002419, -0.021551, -0.022165, -0.029903, -0.027330, -0.018764, -0.037152, -0.054294, -0.088372
#*# 	  -0.026506, -0.013515, -0.011441, -0.003748, -0.010130, -0.002173, 0.004893, -0.006781, -0.000467, 0.002722, 0.012374, 0.006629, -0.020677, -0.013404, -0.026850, -0.025739, -0.023857, -0.039583, -0.057609, -0.093850
#*# 	  -0.034625, -0.018672, -0.009812, -0.009661, -0.010149, -0.000849, 0.007315, 0.003393, 0.006698, 0.022810, 0.018905, 0.004962, -0.019580, -0.018194, -0.019086, -0.017566, -0.011255, -0.027276, -0.045116, -0.080956
#*# 	  -0.034107, -0.018310, -0.012544, -0.003333, -0.003919, 0.004012, 0.017103, -0.000869, 0.008230, 0.014784, 0.017074, 0.018262, -0.011798, 0.000381, -0.013762, -0.013354, -0.005955, -0.023514, -0.042674, -0.075736
#*# 	  -0.040009, -0.024766, -0.008634, -0.008372, -0.012708, 0.001075, 0.008729, 0.007867, 0.008376, 0.019291, 0.023637, 0.012193, -0.018852, -0.004709, -0.006731, -0.004985, 0.000769, -0.016949, -0.036509, -0.068245
#*# 	  -0.036962, -0.025217, -0.020683, -0.007392, -0.008005, 0.002606, 0.011240, 0.009547, 0.018591, 0.011535, 0.019372, 0.014754, -0.010765, -0.003534, -0.012003, -0.013001, -0.006054, -0.018524, -0.040483, -0.070613
#*# 	  -0.030793, -0.012890, -0.007640, -0.000964, 0.005952, 0.010272, 0.021754, 0.020247, 0.027001, 0.022042, 0.033562, 0.019992, -0.002378, 0.006122, -0.002174, -0.002720, -0.005132, -0.015971, -0.037311, -0.064603
#*# 	  -0.032488, -0.022903, -0.018584, -0.005645, -0.004286, 0.002247, 0.012265, 0.015550, 0.025196, 0.020113, 0.027790, 0.017459, -0.006528, 0.006448, -0.004418, -0.007191, -0.002511, -0.019580, -0.039602, -0.066887
#*# 	  -0.025072, -0.018281, -0.009815, -0.003406, -0.003473, 0.005049, 0.011099, 0.015909, 0.023711, 0.019258, 0.034227, 0.018844, 0.000746, 0.015693, 0.010843, 0.018172, 0.019682, 0.002715, -0.027637, -0.057404
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 215.0
#*# min_y = 20.0
#*# max_y = 190.0
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 2750
#*# scanner_touch_speed = 3
#*# scanner_touch_z_offset = 0.140
#*#
#*# [scanner model default]
#*# model_coef = 2.0451077483356555,
#*# 	1.6607884787592444,
#*# 	-0.6019935400970867,
#*# 	1.629276093959081,
#*# 	8.709154577535902,
#*# 	-9.66168769158157,
#*# 	-17.720057116448423,
#*# 	20.3307394447895,
#*# 	10.522175211672552,
#*# 	-11.916968512717027
#*# model_domain = 3.2790314002932685e-07,3.3591588206894234e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 25.245939
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
