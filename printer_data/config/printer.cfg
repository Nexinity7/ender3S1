[include shell_command.cfg]
# This file contains pin mappings for the stock 2021 Creality Ender 3
# S1 & S1 Pro. To use this config, check the STM32 Chip on the
# Mainboard, during "make menuconfig" select accordingly either the
# STM32F103 with "28KiB bootloader" or the STM32F401 with
# "64KiB bootloader" and serial (on USART1 PA10/PA9) for both.

# For a direct serial connection, in "make menuconfig" select
# "Enable extra low-level configuration options" and  Serial
# (on USART2 PA3/PA2), which is on the 10 pin IDC cable used
# for the LCD module as follows: 3: Tx, 4: Rx, 9: GND, 10: VCC

# Flash this firmware by copying "out/klipper.bin" to a SD card and
# turning on the printer with the card inserted. The filename
# must be changed to "firmware.bin"

# With STM32F401, you might need to put "firmware.bin" in a
# folder on the SD card called "STM32F4_UPDATE" in order to flash.

# See docs/Config_Reference.md for a description of parameters.

[include mainsail.cfg]
[exclude_object]
#[include timelapse.cfg]

# Uncomment for resonance testing w/ ADXL345
#include btt-adxl345.cfg]

##Begin KAMP section

# This file contains all settings for KAMP, and must be included in printer.cfg with:
[include KAMP_Settings.cfg]

### The following [includes] can be uncommented from within KAMP_Settings.cfg. ###

# This file enables the use of adaptive meshing.
#[include Adaptive_Meshing.cfg]

# This file enables the use of adaptive line purging.
#[include ./KAMP/Line_Purge.cfg]

# This file enables the use of the adaptive Voron logo purge.
[include ./KAMP/Voron_Purge.cfg]

# This file enables the use of KAMP's Smart Park feature.
#[include ./KAMP/Smart_Park.cfg]

##End KAMP

[include K-ShakeTune/*.cfg]

#[include part-cooling.cfg]

[firmware_retraction]
retract_length: 0.8
#   The length of filament (in mm) to retract when G10 is activated,
#   and to unretract when G11 is activated (but see
#   unretract_extra_length below). The default is 0 mm.
retract_speed: 60
#   The speed of retraction, in mm/s. The default is 20 mm/s.
unretract_extra_length: 0
#   The length (in mm) of *additional* filament to add when
#   unretracting.
unretract_speed: 40
#   The speed of unretraction, in mm/s. The default is 10 mm/s.

[gcode_macro START_PRINT]
description: Concurrent heat → mesh → pre-touch wipe (≤150C) → CARTO touch → heat to HOT → post-wipe → purge
gcode:
  {% set BED   = params.BED_TEMP|default(60)|int %}
  {% set HOT   = params.EXTRUDER_TEMP|default(205)|int %}
  {% set TOUCH = 150 if HOT > 150 else HOT %}

  G90
  M83
  G92 E0

  ; start both heaters
  M140 S{BED}                 ; bed heat (no wait)
  M104 S{TOUCH}               ; nozzle toward ≤150C (no wait)
  M106 S255                   ; part fan on to solidify ooze
  G28                         ; home while heating
  M190 S{BED}                 ; wait for bed at temp
  M109 S{TOUCH}               ; ensure nozzle is at touch temp (≤150C)

  ; --- WIPE AND LEVEL ---
  G28 Z
  CLEAN_NOZZLE
  BED_MESH_CLEAR
  BED_MESH_CALIBRATE          ; standard Klipper mesh (no adaptive plugin)

  ; --- PRE-TOUCH WIPE @ ~150C ---
  CLEAN_NOZZLE
  CARTOGRAPHER_TOUCH          ; precision touch (requires ≤150C)

  ; --- HEAT TO FINAL TEMP, THEN POST-WIPE ---
  M109 S{HOT}                 ; go to final print temp and wait
  CLEAN_NOZZLE                ; post-heat wipe at print temp

  ; purge and start
  M106 S0
  VORON_PURGE
  G92 E0


[gcode_macro END_PRINT]
description: Move head up, push bed out, and shutdown all steppers and heaters
gcode:
  G91 ;Relative positioning
  G1 E-2 F2700 ;Retract a bit
  G1 E-2 Z0.2 F2400 ;Retract and raise Z
  G1 X5 Y5 F3000 ;Wipe out
  G1 Z10 ;Raise Z more
  G90 ;Absolute positioning

  G1 X20 Y200 ;Present print
  M106 S0 ;Turn-off fan
  M104 S0 ;Turn-off hotend
  M140 S0 ;Turn-off bed

  M84 X Y E ;Disable all steppers but Z

[gcode_arcs]
resolution: 0.1
#   An arc will be split into segments. Each segment's length will
#   equal the resolution in mm set above. Lower values will produce a
#   finer arc, but also more work for your machine. Arcs smaller than
#   the configured value will become straight lines. The default is
#   1mm.

[stepper_x]
step_pin: PC2
dir_pin: PB9
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: !PA5
position_endstop: -4
position_max: 250
position_min: -6
homing_speed: 100

[stepper_y]
step_pin: PB8
dir_pin: PB7
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: !PA6
position_endstop: -8
position_max: 235.5
position_min: -10
homing_speed: 100

[stepper_z]
step_pin: PB6
dir_pin: !PB5
enable_pin: !PC3
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_max: 260
position_min: -4
homing_retract_dist: 0

[tmc2208 stepper_x]
uart_pin: PB1
sense_resistor: 0.150
run_current: 0.7
hold_current: 0.5
interpolate: True
stealthchop_threshold: 0

[tmc2208 stepper_y]
uart_pin: PA13
sense_resistor: 0.150
run_current: 0.75
hold_current: 0.5
interpolate: True
stealthchop_threshold: 0

[tmc2208 stepper_z]
uart_pin: PA14
sense_resistor: 0.150
run_current: 0.7
interpolate: True
stealthchop_threshold: 0

[tmc2208 extruder]
uart_pin: PA3
sense_resistor: 0.150
run_current: 0.8
interpolate: True
stealthchop_threshold: 0

[extruder]
step_pin: PB4
dir_pin: PB3
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12
#Rotation distance calibrated 05/24/24
#rotation_distance: 26.359 (original)
#rotation_distance: 26.443 (dads)
#rotation_distance: 26.648
#rotation_distance: 26.968
#rotation_distance: 26.563
#rotation_distance: 26.653
rotation_distance: 26.626
#rotation_distance: 26.613

nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
pressure_advance: 0.02
min_temp: 0
max_temp: 300
max_extrude_cross_section: 5 # Added for KAMP
max_extrude_only_distance: 101

[heater_bed]
heater_pin: PA7
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 105

[heater_fan hotend_fan]
pin: PC0

[fan]
pin: PA0

#[bltouch]
#sensor_pin: ^PC14
#control_pin: PC13
#x_offset: -45.0
#y_offset: 0.0
#probe_with_touch_mode: true
#stow_on_each_sample: false
#z_offset = 3.225

[mcu]
serial: /dev/ttyUSB0
#serial: /dev/serial/by-path/platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.2:1.0-port0
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 5000
max_z_velocity: 10
max_z_accel: 100

[mcu scanner] 
serial: /dev/serial/by-id/usb-Cartographer_614e_38002100124330394D363620-if00

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: -39.2                        
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.062
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[bed_mesh]
speed: 250
horizontal_move_z: 5.2
mesh_min: 20,20
mesh_max: 215,190
probe_count: 25,25
algorithm: bicubic
bicubic_tension: 0.2
mesh_pps: 4, 4
fade_start: 1
fade_end: 10
fade_target: 0
zero_reference_position: 117.00,115.00
#move_check_distance: 5
#split_delta_z: .025

[safe_z_home]
home_xy_position: 117, 151.5
speed: 200
z_hop: 10
z_hop_speed: 10

[filament_switch_sensor e0_sensor]
switch_pin: !PC15
pause_on_runout: true
runout_gcode: PAUSE

[pause_resume]
recover_velocity: 25

[screws_tilt_adjust]
screw1: 26, 220
screw2: 201, 220
screw3: 201, 70
screw4: 26, 70
screw1_name: Back Left
screw2_name: Back Right
screw3_name: Front Right
screw4_name: Front Left
speed: 250
horizontal_move_z: 5.2
screw_thread: CW-M4

[gcode_macro screw_tilt]
gcode:
  G28
  SCREWS_TILT_CALCULATE
  
[bed_screws]
#screw1: 66, 192
#screw2: 240, 192
#screw3: 240, 22
#screw4: 66, 22
screw1: 26, 26
screw2: 201, 26
screw3: 201, 195
screw4: 26, 195

[input_shaper]
shaper_type_x = mzv
shaper_freq_x = 61.2
# ei at 79.8 Hz <=11700 accel 6/6/24
# mzv at 61.2 Hz <=11000 accel 7/29/25
shaper_type_y = mzv
shaper_freq_y = 37.0
# ei at 54.2Hz <=5400 accel 6/6/24
# mzv at 37.0 Hz <=4000 accel 7/29/25

[include macros.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 19.605
#*# pid_ki = 0.927
#*# pid_kd = 103.662
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 74.493
#*# pid_ki = 2.087
#*# pid_kd = 664.849
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.030455, 0.054943, 0.036217, 0.011411, 0.010225, 0.015572, 0.046423, 0.080126, 0.101306, 0.103869, 0.076248, 0.058071, 0.048355, 0.033619, 0.069078, 0.086051, 0.106740, 0.133395, 0.125103, 0.107595, 0.075264, 0.062572, 0.093043, 0.114290, 0.139679
#*# 	  0.014355, 0.041670, 0.033306, 0.017488, 0.000464, 0.000612, 0.035366, 0.067738, 0.069218, 0.080109, 0.058708, 0.052063, 0.034457, 0.023399, 0.055910, 0.075607, 0.092658, 0.111500, 0.105235, 0.092967, 0.061521, 0.053042, 0.083320, 0.101111, 0.128767
#*# 	  0.030025, 0.037870, 0.038902, 0.012679, -0.002358, -0.000579, 0.037180, 0.058506, 0.071223, 0.077752, 0.059287, 0.044813, 0.026622, 0.018506, 0.048919, 0.072728, 0.106097, 0.115594, 0.093842, 0.082550, 0.054925, 0.049365, 0.079999, 0.097904, 0.118345
#*# 	  0.004321, 0.001386, 0.003673, -0.010094, -0.023186, -0.017963, 0.004229, 0.041180, 0.044392, 0.050745, 0.031658, 0.027100, 0.010020, -0.001277, 0.035239, 0.050250, 0.082307, 0.110159, 0.080897, 0.065895, 0.046209, 0.033318, 0.066402, 0.084100, 0.089778
#*# 	  -0.002857, 0.000820, -0.011901, -0.036098, -0.037487, -0.024668, 0.006686, 0.033399, 0.025621, 0.055373, 0.034487, 0.019782, 0.004982, 0.000291, 0.032997, 0.060588, 0.082666, 0.096143, 0.084266, 0.069461, 0.049267, 0.040536, 0.071038, 0.093622, 0.119758
#*# 	  -0.028521, -0.027335, -0.045922, -0.099668, -0.069723, -0.047625, -0.018435, 0.015788, 0.018583, 0.023611, 0.008967, 0.000090, -0.014354, -0.018029, 0.014694, 0.037706, 0.047064, 0.056674, 0.063025, 0.055277, 0.033294, 0.020689, 0.055347, 0.078767, 0.090089
#*# 	  -0.036106, -0.031245, -0.022472, -0.049493, -0.064416, -0.053751, -0.017049, -0.000094, 0.006930, 0.013293, 0.012828, -0.001366, -0.013696, -0.016293, 0.018552, 0.042359, 0.066555, 0.081333, 0.072117, 0.057594, 0.038577, 0.028797, 0.062389, 0.088527, 0.099936
#*# 	  -0.055626, -0.050199, -0.061811, -0.107195, -0.087511, -0.063817, -0.033424, 0.006721, 0.010807, 0.015487, 0.001121, -0.004228, -0.015849, -0.018359, 0.020360, 0.043897, 0.078211, 0.093768, 0.078157, 0.072830, 0.045749, 0.037775, 0.072285, 0.092175, 0.094408
#*# 	  -0.070798, -0.060092, -0.108058, -0.116474, -0.112298, -0.074955, -0.031527, 0.016362, 0.035135, 0.022502, 0.017949, -0.001222, -0.015341, -0.017481, 0.019311, 0.041992, 0.064905, 0.086078, 0.085008, 0.072263, 0.049237, 0.041047, 0.070793, 0.103600, 0.125449
#*# 	  -0.071947, -0.066800, -0.067732, -0.091279, -0.085691, -0.058511, -0.032847, 0.002056, 0.010268, 0.027404, 0.011599, -0.007495, -0.015053, -0.016490, 0.020613, 0.042988, 0.068781, 0.065271, 0.083289, 0.076707, 0.049393, 0.041110, 0.075900, 0.097396, 0.113833
#*# 	  -0.114086, -0.106835, -0.075801, -0.066635, -0.075117, -0.055194, -0.029082, -0.005214, -0.008962, 0.024255, 0.008260, -0.007192, -0.011916, -0.016414, 0.024338, 0.053292, 0.080852, 0.094850, 0.085253, 0.071519, 0.052411, 0.042022, 0.077867, 0.102466, 0.117794
#*# 	  -0.077191, -0.077965, -0.078909, -0.096707, -0.093571, -0.069830, -0.031249, 0.002495, 0.008615, 0.031125, 0.014128, -0.003898, -0.011543, -0.015597, 0.020560, 0.037983, 0.071454, 0.086495, 0.087631, 0.077400, 0.050670, 0.046003, 0.073620, 0.102857, 0.114486
#*# 	  -0.080097, -0.067817, -0.079981, -0.093063, -0.085280, -0.067433, -0.025294, 0.006174, 0.016058, 0.011379, 0.005296, 0.010888, -0.001834, -0.004721, 0.026362, 0.054133, 0.068342, 0.094139, 0.092579, 0.075802, 0.053061, 0.041015, 0.077984, 0.096610, 0.120020
#*# 	  -0.068544, -0.064722, -0.070997, -0.092121, -0.077635, -0.062538, -0.027002, 0.007218, 0.015447, 0.031745, 0.019059, 0.006095, -0.001024, -0.004947, 0.027782, 0.054842, 0.091347, 0.095091, 0.089923, 0.077224, 0.054298, 0.039283, 0.073271, 0.098724, 0.094173
#*# 	  -0.064361, -0.052302, -0.095965, -0.102490, -0.075694, -0.053789, -0.011006, 0.026403, 0.048279, 0.049317, 0.008180, 0.001969, 0.006088, -0.001934, 0.030010, 0.057290, 0.084812, 0.109435, 0.102856, 0.078401, 0.057157, 0.040698, 0.075217, 0.097774, 0.107414
#*# 	  -0.060619, -0.051701, -0.067073, -0.103047, -0.091761, -0.055705, -0.014933, 0.022003, 0.025402, 0.031562, 0.027975, 0.009675, 0.005075, -0.000495, 0.034029, 0.070397, 0.084902, 0.089515, 0.097945, 0.088916, 0.056262, 0.048119, 0.085075, 0.102558, 0.111497
#*# 	  -0.055371, -0.070452, -0.049707, -0.065245, -0.058310, -0.036359, 0.000700, 0.031425, 0.041529, 0.046942, 0.022616, 0.019346, 0.014111, 0.009188, 0.039504, 0.067276, 0.095252, 0.110124, 0.101538, 0.090173, 0.066761, 0.059057, 0.089104, 0.107031, 0.126719
#*# 	  -0.046424, -0.050350, -0.035661, -0.039538, -0.044115, -0.034766, -0.000546, 0.038479, 0.046771, 0.052351, 0.040313, 0.029715, 0.018259, 0.012592, 0.042235, 0.056730, 0.081058, 0.129889, 0.108452, 0.096930, 0.069604, 0.061573, 0.089811, 0.101758, 0.094408
#*# 	  -0.078416, -0.041794, -0.046087, -0.064354, -0.046497, -0.031339, 0.010513, 0.052084, 0.047832, 0.056309, 0.042371, 0.024627, 0.023739, 0.016787, 0.049071, 0.081064, 0.110860, 0.126791, 0.101244, 0.090617, 0.068742, 0.056440, 0.084790, 0.086970, 0.090293
#*# 	  -0.051396, -0.050038, -0.047328, -0.063718, -0.045750, -0.032447, 0.000878, 0.037797, 0.049580, 0.059988, 0.050907, 0.037692, 0.024256, 0.017246, 0.049009, 0.068481, 0.091057, 0.108910, 0.103732, 0.089972, 0.064838, 0.051985, 0.078414, 0.096931, 0.100541
#*# 	  -0.040498, -0.065087, -0.068947, -0.056757, -0.049630, -0.030123, 0.009784, 0.048205, 0.057463, 0.052955, 0.047131, 0.036850, 0.029361, 0.020224, 0.048502, 0.069938, 0.093602, 0.113553, 0.099788, 0.081812, 0.059955, 0.047996, 0.071825, 0.089576, 0.089398
#*# 	  -0.069040, -0.068119, -0.035161, -0.053579, -0.032663, -0.021477, 0.012070, 0.035101, 0.046786, 0.057508, 0.056621, 0.049756, 0.037733, 0.023500, 0.048104, 0.063694, 0.089909, 0.105812, 0.103141, 0.086320, 0.059396, 0.045428, 0.062654, 0.076662, 0.084231
#*# 	  -0.022794, -0.020208, -0.035132, -0.059451, -0.044028, -0.017224, 0.018236, 0.051394, 0.054394, 0.066457, 0.060607, 0.055165, 0.039687, 0.028685, 0.052990, 0.067417, 0.087564, 0.101303, 0.091131, 0.073399, 0.051182, 0.036722, 0.059350, 0.064533, 0.066860
#*# 	  -0.028310, -0.025989, -0.025201, -0.031880, -0.027207, -0.011173, 0.025963, 0.058453, 0.057265, 0.069523, 0.067583, 0.062586, 0.046387, 0.033230, 0.056040, 0.069910, 0.088843, 0.102818, 0.085905, 0.071710, 0.046739, 0.031806, 0.052469, 0.060572, 0.064323
#*# 	  -0.012102, -0.021660, -0.042814, -0.057489, -0.050297, -0.001796, 0.034932, 0.056080, 0.068878, 0.075941, 0.066815, 0.060759, 0.048430, 0.039936, 0.064115, 0.075453, 0.092492, 0.107306, 0.090119, 0.075820, 0.049313, 0.033730, 0.058786, 0.058074, 0.074583
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 215.0
#*# min_y = 20.0
#*# max_y = 190.0
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 4000
#*# scanner_touch_speed = 3
#*# scanner_touch_z_offset = 0.135
#*#
#*# [scanner model default]
#*# model_coef = 2.0451077483356555,
#*# 	1.6607884787592444,
#*# 	-0.6019935400970867,
#*# 	1.629276093959081,
#*# 	8.709154577535902,
#*# 	-9.66168769158157,
#*# 	-17.720057116448423,
#*# 	20.3307394447895,
#*# 	10.522175211672552,
#*# 	-11.916968512717027
#*# model_domain = 3.2790314002932685e-07,3.3591588206894234e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 25.245939
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
