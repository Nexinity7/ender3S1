[gcode_macro CLEAN_NOZZLE]
# Brush rectangle (bottom-left to top-right)
variable_x0: 98.5
variable_y0: 230.5
variable_x1: 133.5
variable_y1: 235.5

# Behavior
variable_wipe_z: 0.3        # wipe height above bed (0.4â€“0.6)
variable_travel_z: 5.0      # safe travel Z before/after wiping
variable_rows: 10           # how many Y lanes across the brush
variable_cycles: 2          # repeat the whole raster this many times
variable_spd: 100           # mm/s for scrubbing moves
variable_margin: 0.5        # stay inside brush edges

gcode:
  {% if "xyz" not in printer.toolhead.homed_axes %}
    G28
  {% endif %}
  G90

  # Allow overrides via params (optional)
  {% set x0 = params.X0|default(x0)|float %}
  {% set y0 = params.Y0|default(y0)|float %}
  {% set x1 = params.X1|default(x1)|float %}
  {% set y1 = params.Y1|default(y1)|float %}
  {% set wipe_z = params.Z|default(wipe_z)|float %}
  {% set travel_z = params.TRAVEL_Z|default(travel_z)|float %}
  {% set rows = params.ROWS|default(rows)|int %}
  {% set cycles = params.CYCLES|default(cycles)|int %}
  {% set mar = params.MARGIN|default(margin)|float %}
  {% set spd = (params.SPD|default(spd)|float) * 60 %}  # mm/min

  {% set start_x = x0 + mar %}
  {% set end_x   = x1 - mar %}
  {% set y_low   = y0 + mar %}
  {% set y_high  = y1 - mar %}
  {% set dy = 0 if rows <= 1 else (y_high - y_low) / (rows - 1) %}
  {% set curz = printer.toolhead.position.z|float %}

  # 1) go to safe travel Z, then to brush at travel Z (no ooze smear on bed)
  {% if curz < travel_z %}
    G1 Z{travel_z} F1500
  {% endif %}
  G1 X{start_x} Y{y_low} F6000

  # 2) drop to wipe height and raster
  G1 Z{wipe_z} F900
  {% for c in range(cycles) %}
    {% for r in range(rows) %}
      {% set y = y_low + (dy * r) %}
      G1 Y{y} F{spd}
      {% if (r % 2) == 0 %}
        G1 X{end_x}   F{spd}
      {% else %}
        G1 X{start_x} F{spd}
      {% endif %}
    {% endfor %}
  {% endfor %}

  # 3) lift back to travel Z
  G1 Z{travel_z} F1500


[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
# change this if you need more or less extrusion
variable_extrude: 1.0
gcode:
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  ##### set park positon for x and y #####
  # default is your max posion from your printer.cfg
  {% set x_park = printer.toolhead.axis_maximum.x|float - 25.0 %}
  {% set y_park = printer.toolhead.axis_maximum.y|float - 25.0 %}
  ##### calculate save lift position #####
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% if act_z < (max_z - 2.0) %}
      {% set z_safe = 2.0 %}
  {% else %}
      {% set z_safe = max_z - act_z %}
  {% endif %}
  ##### end of definitions #####
  PAUSE_BASE
  G91
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G1 E-{E} F2100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}
  {% if "xyz" in printer.toolhead.homed_axes %}
    G1 Z{z_safe} F900
    G90
    G1 X{x_park} Y{y_park} F6000
  {% else %}
    {action_respond_info("Printer not homed")}
  {% endif %} 